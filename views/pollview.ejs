<!doctype HTML5>
<html>
<head>
<meta charset="utf-8">
<title>MUNSSN-Course Polling</title>
<link href="CSS/navCSS.css" rel="stylesheet" type="text/css">
<link href="CSS/eiCSS.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-blue-grey.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js" type="text/javascript"></script>
<script src="JS/eiJS.js"></script>
<script src="JS/momentjs.js"></script>
<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>

</head>
<body>
<!-- <div id="banner">
	<h2>Test Information</h2>
	<p>some nonsense I guess</p>
</div> -->
<div class="w3-bar w3-border  w3-text-white w3-collaspe " id="nav_bar">
	<a href="/profile" class="w3-bar-item w3-button w3-hover-none  w3-hover-text-grey w3-padding-16">MUNSSN</a>
	<a href="/group" class="w3-bar-item w3-button w3-hover-none w3-hover-text-grey w3-padding-16">Group</a>
	<a href="/friend" class="w3-bar-item w3-button  w3-hover-none  w3-hover-text-grey w3-padding-16">Friends</a>
	<a href="/lostandfound" class="w3-bar-item w3-button  w3-hover-none  w3-hover-text-grey w3-padding-16">Lost and Found</a>
	<a href="/chatroom" class="w3-bar-item w3-button w3-hover-none  w3-hover-text-grey w3-padding-16">chatroom</a>
	<div class="w3-dropdown-hover w3-right">
<button class="w3-button w3-hover-none w3-hover-text-grey"><img src="<%=user.image%>"class="w3-bar-item" width="42px" height="42px"><p class="w3-bar-item w3-margin-right" id='user_email' alt='<%=user.local.email%>'><%= user.name.first%></p></button>
<div class="w3-dropdown-content w3-bar-block w3-cards">
	<a href="/profile" class="w3-bar-item w3-button">profile</a>
	<a href="#" class="w3-bar-item w3-button">Setting</a>
	<a href="/logout" class="w3-bar-item w3-button">Logout</a>
</div>
</div>
</div>
<div>

  <h1> poll view is here</h1>
  <form method="post" action="/createpoll" >
    <input  type='text' name='course' value=''>
    <textarea name='description' value='' placeholder="Enter the question here"></textarea>
    <input type ='hidden' name="options_value" id="options_value" value="">
    <div id ='options'>
      Option <input type ='text' name="question" value=''><br>
    </div>
     <p class='w3-button w3-grey' id='addquestion'>+</p><br>
     <button type='submit' id="create_options">Create</button>

  </form>
</div>

<div id = 'bodyview'>
 <input type ="hidden" value ="<%= pollist.length%>" id='length'/>
  <% pollist.forEach(function(poll, index){%>
    <img src='<%=poll.postby.image%>' width="50" height="50"/>
    <span> <%=poll.postby.name.first%> <%=poll.postby.name.last%></span>  <br>  <time id="then" datetime="<%= poll.date%>"></time><br>

    <h3><%=poll.body%></h3>
    <h4><%=poll.course%></h4>
			<div id='option_area<%=index%>'>

    <% poll.options.forEach(function(p){%>
			<% if(voted[index]){ %>
				<script>
				$(function(){
					$('#vote'+<%=index%>).hide();
				});
				</script>
				 <div class='w3-card'style='max-width:600px'><div class='w3-card w3-grey'style='width:<%=(p.total_vote/poll.__v)*100 %>%'><%=p.text%></div></div>
			<%} else {%>
				<input type="radio" name="options[]" value="<%=p._id%>"><%=p.text%><br>
				<%}%>
		<%})%>
	</div>

      <button type="submit" value="<%=poll._id%>" id='vote<%=index%>' alt="<%=index%>">Vote</button><br>
<%  }) %>
</div>
<script>

$(function(){
  $('#addquestion').click(function(event){
    $('#options').append("Option <input type ='text' name='qeustion' value=''> <br>");
  });

});
$(function(){
  $('#create_options').click(function(event){
    var options="";
  $("#options").children().each(function ()
  {
      options += $(this).val()+"|";
  });
  $('#options_value').val(options);
  });
});

$(function(){
var socket = io().connect();
var length = $('#length').val();
var click = 0;
for(i = 0 ; i < length; i++){
$('#vote'+i).click(function(event){
  var radio= $("input[name='options[]']:checked");
  console.log(radio.val(), $(this).val());
  var info = {poll_id: $(this).val(), option_id:radio.val(),user_id: $('#user_email').attr('alt')};
  socket.emit('vote', info);
  click = $(this).attr('alt');
  // return false

  });
}
socket.on('vote', function(info){
	drawRect(info.totalVote, info.Options,click);
	});

});

function drawRect(total, options, index){
	var option_area = $('#option_area'+index);
	option_area.empty();
	console.log(total);
	options.forEach(function(op){
		console.log(op.total_vote);
		option_area.append("<div class='w3-card'style='max-width:600px'><div class='w3-card w3-grey'style='width:"+(op.total_vote/total)*100+"%'>"+op.text+"</div></div>");
	});
	$('#vote'+index).hide();
}

</script>
</body>

</html>
